{% extends 'base/base.html' %}
{% load static %}

{% block title %}Payment - FX Bot Monitor{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-mobile">
        <!-- Back Button -->
        <div class="mb-4">
            <a href="{% url 'subscription_packages' %}" class="btn btn-glass btn-sm">
                <i class="bi bi-arrow-left me-2"></i>กลับ
            </a>
        </div>

        <!-- Header -->
        <div class="mb-4 fade-in">
            {% if renew_account %}
            <h1 class="mb-2">ชำระเงิน (ต่ออายุ)</h1>
            <p class="text-secondary">สแกน QR Code หรือโอนผ่านธนาคาร</p>
            <div class="alert mt-2" style="background: rgba(21, 139, 249, 0.1); border: 1px solid rgba(21, 139, 249, 0.3); border-radius: 12px;">
                <small class="text-primary-blue">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>ต่ออายุสำหรับ:</strong> {{ renew_account.account_name }}
                </small>
            </div>
            {% else %}
            <h1 class="mb-2">ชำระเงิน</h1>
            <p class="text-secondary">สแกน QR Code หรือโอนผ่านธนาคาร</p>
            {% endif %}
        </div>

        <!-- Package Summary -->
        <div class="glass-card fade-in mb-4" style="animation-delay: 0.1s; padding: 24px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-secondary">แพ็คเกจที่เลือก</span>
                <span class="badge-glass badge-primary-blue">{{ package.name }}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-secondary">ระยะเวลา</span>
                <span>{{ package.duration_days }} วัน</span>
            </div>
            
            <!-- Referral Discount Display (hidden by default) -->
            <div id="discount-section" style="display: none;">
                <div class="divider"></div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-secondary">ราคาเต็ม</span>
                    <span id="original-price" style="text-decoration: line-through; color: var(--text-muted);">
                        ฿{{ package.price|floatformat:0 }}
                    </span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="color: #10b981; font-weight: 500;">ส่วนลด Referral</span>
                    <span id="discount-amount" style="color: #10b981; font-weight: 600;">
                        -฿0
                    </span>
                </div>
            </div>
            
            <div class="divider"></div>
            <div class="d-flex justify-content-between align-items-center">
                <span style="font-size: 18px; font-weight: 600;">ยอดชำระ</span>
                <span id="final-price" style="font-size: 28px; font-weight: 700; color: var(--primary-blue);">
                    ฿{{ package.price|floatformat:0 }}
                </span>
            </div>
        </div>

        <!-- Referral Code Section (moved before QR code) -->
        <div class="glass-card fade-in mt-4" style="animation-delay: 0.15s; padding: 24px;">
            <h5 class="mb-3">รหัส Referral (ไม่บังคับ)</h5>
            
            <div class="mb-2">
                <label for="referral_code_preview" class="form-label">มีรหัส Referral หรือไม่?</label>
                <input type="text" 
                       class="form-control form-control-glass" 
                       id="referral_code_preview" 
                       placeholder="เช่น: aB3xY9Zk">
                <small id="referral-message" class="text-muted">หากมีรหัส Referral คุณอาจได้รับส่วนลดเพิ่มเติม</small>
            </div>
        </div>

        <!-- QR Code for PromptPay -->
        <div class="glass-card fade-in text-center mt-4" style="animation-delay: 0.2s; padding: 24px;">
            <h5 class="mb-3">สแกน QR Code</h5>
            <p class="text-secondary mb-3" style="font-size: 14px;">
                สแกนด้วยแอปฯ Mobile Banking ของคุณ
            </p>
            
            <div class="qr-container">
                <div class="qr-code">
                    <!-- QR Code will be generated here -->
                    <img src="https://via.placeholder.com/200x200/ffffff/158bf9?text=QR+Code" alt="QR Code" style="width: 200px; height: 200px;">
                </div>
            </div>

            <p class="text-muted mt-3" style="font-size: 13px;">
                <i class="bi bi-shield-check me-1"></i>
                PromptPay ID: XXX-XXX-XXXX
            </p>
        </div>

        <!-- OR Divider -->
        <!-- <div class="text-center my-4 fade-in" style="animation-delay: 0.3s;">
            <span class="text-secondary" style="background: var(--bg-dark-start); padding: 0 16px; position: relative; z-index: 1;">
                หรือ
            </span>
            <div style="position: relative; top: -12px; height: 1px; background: var(--border-subtle); z-index: 0;"></div>
        </div> -->

        <!-- Bank Transfer Info -->
        <!-- <div class="glass-card fade-in" style="animation-delay: 0.4s; padding: 24px;">
            <h5 class="mb-3">โอนเงินผ่านธนาคาร</h5>
            
            <div class="mb-2">
                <span class="text-secondary" style="font-size: 13px;">ธนาคาร</span>
                <p class="mb-1" style="font-size: 15px; font-weight: 600;">ธนาคารกสิกรไทย</p>
            </div>
            
            <div class="mb-2">
                <span class="text-secondary" style="font-size: 13px;">ชื่อบัญชี</span>
                <p class="mb-1" style="font-size: 15px; font-weight: 600;">FX Bot Trading</p>
            </div>
            
            <div class="mb-3">
                <span class="text-secondary" style="font-size: 13px;">เลขที่บัญชี</span>
                <p class="mb-0" style="font-size: 18px; font-weight: 700; color: var(--primary-blue);">
                    XXX-X-XXXXX-X
                    <button class="btn btn-glass btn-sm ms-2" onclick="copyAccountNumber()">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </p>
            </div>

            <div class="alert" style="background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 12px;">
                <small class="text-warning">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    โปรดโอนตามจำนวนที่ระบุเท่านั้น เพื่อความสะดวกในการตรวจสอบ
                </small>
            </div>
        </div> -->

        <!-- Upload Slip Form -->
        <form method="post" action="{% url 'payment_submit' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="package_id" value="{{ package.id }}">
            {% if renew_account %}
            <input type="hidden" name="renew_account_id" value="{{ renew_account.id }}">
            {% endif %}
            
            <!-- Payment Slip Section -->
            <div class="glass-card mt-4 fade-in" style="animation-delay: 0.4s; padding: 24px;">
                <h5 class="mb-3">อัพโหลดสลิปโอนเงิน</h5>
                
                <div class="mb-3">
                    <label for="slip" class="form-label">เลือกรูปสลิป</label>
                    <input type="file" 
                           class="form-control form-control-glass" 
                           id="slip" 
                           name="payment_slip" 
                           accept="image/*" 
                           capture="environment"
                           onchange="FXBot.previewPaymentSlip(this)"
                           required>
                    <small class="text-muted">รองรับ JPG, PNG (สูงสุด 5MB)</small>
                </div>

                <!-- Preview Area -->
                <div id="slip-preview" class="mb-0"></div>
            </div>

            <!-- Referral Code Hidden Input (synced from preview input above) -->
            <input type="hidden" id="referral_code" name="referral_code" value="">

            {% if not renew_account %}
            <!-- Information Section -->
            <div class="glass-card mt-4 fade-in" style="animation-delay: 0.5s; padding: 24px;">
                <div class="d-flex align-items-start">
                    <div class="me-3">
                        <i class="bi bi-info-circle" style="font-size: 24px; color: var(--primary-blue);"></i>
                    </div>
                    <div>
                        <h6 class="mb-2" style="font-weight: 600; color: var(--primary-blue);">ขั้นตอนต่อไป</h6>
                        <p class="text-muted mb-2" style="font-size: 13px;">
                            หลังจากตรวจสอบการชำระเงินเรียบร้อยแล้ว ทีมงานจะแจ้งให้คุณทราบผ่าน LINE หรือ SMS พร้อมลิงก์สำหรับตั้งค่าบัญชี MT5
                        </p>
                        <ul class="text-muted mb-0" style="font-size: 13px; padding-left: 20px;">
                            <li>ตรวจสอบการชำระเงิน (5-15 นาที)</li>
                            <li>กรอกข้อมูล MT5 Account (Account ID, Password, Server)</li>
                            <li>ทีมงานติดตั้ง Bot ให้ (ภายใน 24 ชั่วโมง)</li>
                            <li>เริ่มเทรดได้ทันที</li>
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Submit Button -->
            <div class="glass-card mt-4 fade-in" style="animation-delay: 0.6s; padding: 24px;">
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary-blue btn-lg">
                        <i class="bi bi-check-circle me-2"></i>ส่งหลักฐานการโอนเงิน
                    </button>
                </div>
            </div>
        </form>

        <!-- Help Info -->
        <div class="text-center mt-4 mb-4 fade-in" style="animation-delay: 0.7s;">
            <p class="text-muted" style="font-size: 13px;">
                <i class="bi bi-headset me-1"></i>
                ต้องการความช่วยเหลือ? <a href="#" class="text-primary-blue">ติดต่อทีมงาน</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const PACKAGE_PRICE = {{ package.price }};
    let currentDiscount = 0;
    let debounceTimer;

    // Add event listener after DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        const referralInput = document.getElementById('referral_code_preview');
        if (referralInput) {
            referralInput.addEventListener('input', function() {
                checkReferralCode(this.value);
            });
        }
    });

    function checkReferralCode(code) {
        // Clear previous timer
        clearTimeout(debounceTimer);
        
        // Reset if empty
        if (!code || code.trim() === '') {
            resetDiscount();
            return;
        }
        
        // Debounce API call (wait 500ms after user stops typing)
        debounceTimer = setTimeout(() => {
            validateReferralCode(code.trim());
        }, 500);
    }

    function validateReferralCode(code) {
        // Sync to hidden input for form submission
        document.getElementById('referral_code').value = code;
        
        const messageEl = document.getElementById('referral-message');
        messageEl.innerHTML = '<i class="bi bi-hourglass-split"></i> กำลังตรวจสอบ...';
        messageEl.className = 'text-muted';

        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Call API to validate referral code
        fetch('/api/bot/validate-referral-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                const discountPercent = data.discount_percentage || 0;
                applyDiscount(discountPercent);
                
                if (discountPercent > 0) {
                    messageEl.innerHTML = `<i class="bi bi-check-circle-fill"></i> รหัสถูกต้อง! ได้รับส่วนลด ${discountPercent}%`;
                    messageEl.className = 'text-success';
                } else {
                    messageEl.innerHTML = '<i class="bi bi-check-circle"></i> รหัสถูกต้อง';
                    messageEl.className = 'text-success';
                }
            } else {
                resetDiscount();
                messageEl.innerHTML = '<i class="bi bi-x-circle-fill"></i> ' + (data.message || 'รหัสไม่ถูกต้อง');
                messageEl.className = 'text-danger';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resetDiscount();
            messageEl.innerHTML = '<i class="bi bi-exclamation-triangle"></i> เกิดข้อผิดพลาด กรุณาลองใหม่';
            messageEl.className = 'text-warning';
        });
    }

    function applyDiscount(discountPercent) {
        if (discountPercent <= 0) {
            resetDiscount();
            return;
        }

        currentDiscount = discountPercent;
        const discountAmount = PACKAGE_PRICE * (discountPercent / 100);
        const finalPrice = PACKAGE_PRICE - discountAmount;

        // Show discount section
        document.getElementById('discount-section').style.display = 'block';
        
        // Update amounts with Thai number format
        const formattedDiscount = discountAmount.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        const formattedFinal = finalPrice.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        document.getElementById('discount-amount').textContent = '-฿' + formattedDiscount;
        document.getElementById('final-price').textContent = '฿' + formattedFinal;
    }

    function resetDiscount() {
        currentDiscount = 0;
        document.getElementById('discount-section').style.display = 'none';
        const formattedPrice = PACKAGE_PRICE.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('final-price').textContent = '฿' + formattedPrice;
    }

    function copyAccountNumber() {
        const accountNumber = 'XXX-X-XXXXX-X';
        navigator.clipboard.writeText(accountNumber).then(() => {
            showToast('คัดลอกเลขบัญชีแล้ว', 'success');
        });
    }
</script>
{% endblock %}
