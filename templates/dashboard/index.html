{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - FX Bot Monitor{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-mobile">
        <!-- Header -->
        <div class="mb-4 fade-in">
            <h1 class="mb-2">Dashboard</h1>
            <p class="text-secondary">บัญชีเทรดของคุณ</p>
        </div>

        <!-- Refresh Indicator (hidden by default) -->
        <div id="refresh-indicator" style="opacity: 0; text-align: center; padding: 10px; transition: opacity 0.3s;">
            <i class="bi bi-arrow-down-circle spinner-primary"></i>
        </div>

        <!-- Trading Accounts List -->
        <div id="accounts-container">
            {% if accounts %}
                {% for account in accounts %}
                <div class="account-card glass-card fade-in" data-account-id="{{ account.id }}" onclick="window.location.href='{% url 'account_detail' account.id %}'">
                    <div class="account-card-header">
                        <div>
                            <h3 class="account-name">{{ account.account_name }}</h3>
                            <p class="broker-name">{{ account.broker_name }}</p>
                        </div>
                        <span class="badge-glass {% if account.bot_status == 'ACTIVE' %}badge-active{% elif account.bot_status == 'PAUSED' %}badge-paused{% else %}badge-down{% endif %}">
                            {{ account.get_bot_status_display }}
                        </span>
                    </div>

                    <div class="account-balance">
                        ฿{{ account.current_balance|floatformat:2 }}
                    </div>

                    <div class="account-stats">
                        <div class="stat-item">
                            <span class="stat-label">Open Positions</span>
                            <span class="stat-value">{{ account.open_positions_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current P&L</span>
                            <span class="stat-value {% if account.current_pnl >= 0 %}text-profit{% else %}text-loss{% endif %}">
                                {% if account.current_pnl >= 0 %}+{% endif %}฿{{ account.current_pnl|floatformat:2 }}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Subscription</span>
                            <span class="stat-value {% if account.days_until_expiry <= 7 %}text-loss{% else %}text-secondary{% endif %}">
                                {{ account.days_until_expiry }} วัน
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="empty-state glass-card-static">
                    <i class="bi bi-wallet2"></i>
                    <div class="empty-state-title">ยังไม่มีบัญชีเทรด</div>
                    <div class="empty-state-text">เริ่มต้นด้วยการเพิ่มบัญชีเทรดของคุณ</div>
                    <a href="{% url 'subscription_packages' %}" class="btn btn-primary-blue mt-3">
                        <i class="bi bi-plus-circle me-2"></i>เพิ่มบัญชีเทรด
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Add Account Button -->
        {% if accounts %}
        <div class="mt-4 text-center fade-in">
            <a href="{% url 'subscription_packages' %}" class="btn btn-glass">
                <i class="bi bi-plus-circle me-2"></i>เพิ่มบัญชีเทรด
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
{% include 'base/bottom_nav.html' %}
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard Live Update System
    const DashboardLiveUpdate = {
        updateInterval: 1000, // 1 second
        intervalId: null,
        
        init() {
            this.startAutoUpdate();
        },
        
        startAutoUpdate() {
            // Initial update
            this.fetchAndUpdate();
            
            // Start interval
            this.intervalId = setInterval(() => {
                this.fetchAndUpdate();
            }, this.updateInterval);
        },
        
        stopAutoUpdate() {
            if (this.intervalId) {
                clearInterval(this.intervalId);
                this.intervalId = null;
            }
        },
        
        async fetchAndUpdate() {
            try {
                const response = await fetch('/api/bot/dashboard/live/');
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const result = await response.json();
                if (result.status === 'success') {
                    this.updateAccounts(result.data.accounts);
                }
            } catch (error) {
                console.error('Dashboard update error:', error);
            }
        },
        
        updateAccounts(accounts) {
            accounts.forEach(account => {
                const accountCard = document.querySelector(`[data-account-id="${account.id}"]`);
                if (accountCard) {
                    this.updateAccountCard(accountCard, account);
                }
            });
        },
        
        updateAccountCard(card, data) {
            // Update balance
            const balanceEl = card.querySelector('.account-balance');
            if (balanceEl) {
                const formatted = '฿' + data.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (balanceEl.textContent.trim() !== formatted) {
                    balanceEl.textContent = formatted;
                    this.flashElement(balanceEl);
                }
            }
            
            // Update bot status badge
            const badgeEl = card.querySelector('.badge-glass');
            if (badgeEl && badgeEl.textContent.trim() !== data.bot_status_display) {
                badgeEl.textContent = data.bot_status_display;
                badgeEl.className = 'badge-glass';
                if (data.bot_status === 'ACTIVE') badgeEl.classList.add('badge-active');
                else if (data.bot_status === 'PAUSED') badgeEl.classList.add('badge-paused');
                else badgeEl.classList.add('badge-down');
            }
            
            // Update open positions count
            const openPosEl = card.querySelector('.stat-item:nth-child(1) .stat-value');
            if (openPosEl && openPosEl.textContent.trim() !== data.open_positions_count.toString()) {
                openPosEl.textContent = data.open_positions_count;
                this.flashElement(openPosEl);
            }
            
            // Update current P&L
            const pnlEl = card.querySelector('.stat-item:nth-child(2) .stat-value');
            if (pnlEl) {
                const formatted = (data.current_pnl >= 0 ? '+' : '') + '฿' + data.current_pnl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                if (pnlEl.textContent.trim() !== formatted) {
                    pnlEl.textContent = formatted;
                    pnlEl.className = 'stat-value ' + (data.current_pnl >= 0 ? 'text-profit' : 'text-loss');
                    this.flashElement(pnlEl);
                }
            }
            
            // Update subscription days
            const subsEl = card.querySelector('.stat-item:nth-child(3) .stat-value');
            if (subsEl) {
                const formatted = data.days_until_expiry + ' วัน';
                if (subsEl.textContent.trim() !== formatted) {
                    subsEl.textContent = formatted;
                    subsEl.className = 'stat-value ' + (data.days_until_expiry <= 7 ? 'text-loss' : 'text-secondary');
                }
            }
        },
        
        flashElement(element) {
            element.style.transition = 'all 0.3s ease';
            element.style.transform = 'scale(1.05)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 300);
        }
    };
    
    // Start live updates when page loads
    document.addEventListener('DOMContentLoaded', () => {
        DashboardLiveUpdate.init();
    });
    
    // Stop updates when page is hidden (battery saving)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            DashboardLiveUpdate.stopAutoUpdate();
        } else {
            DashboardLiveUpdate.startAutoUpdate();
        }
    });
</script>
{% endblock %}
