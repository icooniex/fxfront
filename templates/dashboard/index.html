{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - FX Bot Monitor{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-mobile">
        <!-- Header -->
        <div class="mb-4 fade-in">
            <h1 class="mb-2">Dashboard</h1>
            <p class="text-secondary">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <!-- Refresh Indicator (hidden by default) -->
        <div id="refresh-indicator" style="opacity: 0; text-align: center; padding: 10px; transition: opacity 0.3s;">
            <i class="bi bi-arrow-down-circle spinner-primary"></i>
        </div>

        <!-- Today's High Impact News -->
        <!-- DUMMY DATA FOR TESTING UI -->
         {% comment %}
        <div class="news-section glass-card-static mb-4 fade-in" style="background: linear-gradient(135deg, rgba(21, 139, 249, 0.08) 0%, rgba(21, 139, 249, 0.02) 100%); border: 1px solid rgba(21, 139, 249, 0.3); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <i class="bi bi-newspaper" style="font-size: 20px; color: var(--primary-blue);"></i>
                <h3 style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin: 0;">
                    ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <!-- Dummy News 1 - HIGH IMPACT -->
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-glass); border-radius: 8px; padding: 2px 10px; display: flex; align-items: center; gap: 10px;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: #ff4444; flex-shrink: 0;"></div>
                    <div style="min-width: 45px;">
                        <div style="font-size: 13px; font-weight: 600; color: #e0e0e0;">08:30</div>
                    </div>
                    <div style="min-width: 35px; text-align: center;">
                        <span style="display: inline-block; background: rgba(21, 139, 249, 0.2); color: #6BC1FF; font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px;">AUD</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #e0e0e0; line-height: 1.4;">CPI m/m</div>
                    </div>
                </div>
                <!-- Dummy News 3 - MEDIUM IMPACT -->
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-glass); border-radius: 8px; padding: 2px 10px; display: flex; align-items: center; gap: 10px;">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: #ffa726; flex-shrink: 0;"></div>
                    <div style="min-width: 45px;">
                        <div style="font-size: 13px; font-weight: 600; color: #e0e0e0;">15:00</div>
                    </div>
                    <div style="min-width: 35px; text-align: center;">
                        <span style="display: inline-block; background: rgba(21, 139, 249, 0.2); color: #6BC1FF; font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px;">EUR</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #e0e0e0; line-height: 1.4;">German Factory Orders m/m</div>
                    </div>
                </div>
                
            </div>
        </div>
        {% endcomment %}
        
        <!-- Real Data (Comment out dummy and uncomment this when ready) -->
        
        {% if today_news %}
        <div class="news-section glass-card-static mb-4 fade-in" style="background: linear-gradient(135deg, rgba(21, 139, 249, 0.08) 0%, rgba(21, 139, 249, 0.02) 100%); border: 1px solid rgba(21, 139, 249, 0.3); border-radius: 12px; padding: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                <i class="bi bi-newspaper" style="font-size: 20px; color: var(--primary-blue);"></i>
                <h3 style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin: 0;">
                    ‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </h3>
            </div>
            <div style="display: flex; flex-direction: column; gap: 2px;">
                {% for news in today_news %}
                <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-glass); border-radius: 8px; padding: 8px 10px; display: flex; align-items: center; gap: 10px;">
                    <!-- Impact Indicator Dot -->
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: {% if news.impact == 'HIGH' %}#ff4444{% elif news.impact == 'MEDIUM' %}#ffa726{% else %}#66bb6a{% endif %}; flex-shrink: 0;"></div>
                    <div style="min-width: 45px;">
                        <div style="font-size: 13px; font-weight: 600; color: #e0e0e0;">{{ news.time }}</div>
                    </div>
                    <div style="min-width: 35px; text-align: center;">
                        <span style="display: inline-block; background: rgba(21, 139, 249, 0.2); color: #6BC1FF; font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px;">{{ news.currency }}</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #e0e0e0; line-height: 1.4;">{{ news.event }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        

        <!-- Trading Accounts List -->
        <div id="accounts-container">
            {% if accounts %}
                {% for account in accounts %}
                <div class="account-card glass-card fade-in" data-account-id="{{ account.id }}" {% if account.subscription_status != 'PENDING' %}onclick="window.location.href='{% url 'account_detail' account.id %}'" style="cursor: pointer;"{% else %}style="cursor: not-allowed; opacity: 0.7;"{% endif %}>
                    <div class="account-card-header">
                        <div>
                            <h3 class="account-name">{{ account.account_name }}</h3>
                            <p class="broker-name">{{ account.broker_name }} ({{ account.mt5_account_id }})</p>
                        </div>
                        <span class="badge-glass {% if account.subscription_status == 'ACTIVE' %}badge-active{% elif account.subscription_status == 'PENDING' %}badge-warning{% elif account.subscription_status == 'EXPIRED' %}badge-down{% else %}badge-paused{% endif %}">
                            {% if account.subscription_status == 'PENDING' %}‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö{% elif account.subscription_status == 'ACTIVE' %}Active{% elif account.subscription_status == 'EXPIRED' %}‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏{% else %}{{ account.get_subscription_status_display }}{% endif %}
                        </span>
                    </div>

                    <div class="account-balance">
                        ${{ account.current_balance|floatformat:2 }}
                    </div>

                    <div class="account-stats">
                        <div class="stat-item">
                            <span class="stat-label">Open Positions</span>
                            <span class="stat-value">{{ account.open_positions_count }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Current P&L</span>
                            <span class="stat-value {% if account.current_pnl >= 0 %}text-profit{% else %}text-loss{% endif %}">
                                {% if account.current_pnl >= 0 %}+{% endif %}${{ account.current_pnl|floatformat:2 }}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Subscription</span>
                            <span class="stat-value {% if account.days_until_expiry <= 7 %}text-loss{% else %}text-secondary{% endif %}">
                                {{ account.days_until_expiry }} ‡∏ß‡∏±‡∏ô
                            </span>
                        </div>
                    </div>

                    {% if account.active_bot %}
                    <div class="bot-info-section" style="background: rgba(21, 139, 249, 0.05); border: 1px solid rgba(21, 139, 249, 0.2); border-radius: 10px; padding: 12px; margin-top: 16px;">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-robot" style="font-size: 20px; color: var(--primary-blue); margin-right: 10px;"></i>
                                <div>
                                    <div style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 2px;">
                                        {{ account.active_bot.name }} <span style="opacity: 0.7;">v{{ account.active_bot.version }}</span>
                                    </div>
                                    {% if account.trade_config.enabled_symbols %}
                                    <div style="font-size: 11px; color: var(--text-muted);">
                                        {{ account.trade_config.enabled_symbols|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="badge-glass {% if account.bot_status == 'ACTIVE' %}badge-active{% elif account.bot_status == 'PAUSED' %}badge-paused{% else %}badge-down{% endif %}" style="font-size: 11px; padding: 4px 10px;">
                                {{ account.get_bot_status_display }}
                            </span>
                        </div>
                    </div>
                    {% if account.dd_blocked %}
                    <div class="mt-2" style="background: rgba(255, 68, 68, 0.15); border: 1px solid #ff4444; border-radius: 8px; padding: 8px 12px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">üõë</span>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; font-weight: 600; color: #ff4444; margin-bottom: 2px;">DD Protection Active</div>
                                <div style="font-size: 10px; color: #ff4444; opacity: 0.9;">
                                    {% if account.dd_block_reason == 'DAILY_DD_LIMIT' %}
                                        Bot ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô Daily DD Limit
                                    {% elif account.dd_block_reason == 'MAX_ACCOUNT_DD' %}
                                        Bot ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô Max Account DD
                                    {% else %}
                                        Bot ‡∏ñ‡∏π‡∏Å‡∏´‡∏¢‡∏∏‡∏î‡πÇ‡∏î‡∏¢ DD Protection
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="empty-state glass-card-static">
                    <i class="bi bi-wallet2"></i>
                    <div class="empty-state-title">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡∏£‡∏î</div>
                    <div class="empty-state-text">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                    <a href="{% url 'subscription_packages' %}" class="btn btn-primary-blue mt-3">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡∏£‡∏î
                    </a>
                </div>
            {% endif %}
        </div>

        <!-- Add Account Button -->
        {% if accounts %}
        <div class="mt-4 text-center fade-in">
            <a href="{% url 'subscription_packages' %}" class="btn btn-glass">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏ó‡∏£‡∏î
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
{% include 'base/bottom_nav.html' %}
{% endblock %}
