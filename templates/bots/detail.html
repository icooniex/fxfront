{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ bot.name }} - FX Bot Monitor{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container-mobile">
        <!-- Back Button -->
        <div class="mb-3">
            <a href="{% url 'bots_list' %}" class="btn btn-glass btn-sm">
                <i class="bi bi-arrow-left me-2"></i>‡∏Å‡∏•‡∏±‡∏ö
            </a>
        </div>

        <!-- Bot Header -->
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h2 class="mb-2">ü§ñ {{ bot.name }}</h2>
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge-glass {% if bot.status == 'ACTIVE' %}badge-active{% elif bot.status == 'BETA' %}badge-warning{% else %}badge-paused{% endif %}">
                            {{ bot.get_status_display }}
                        </span>
                        <span class="badge-glass" style="background: rgba(21, 139, 249, 0.1); color: #158bf9;">v{{ bot.version }}</span>
                        {% if bot.strategy_type %}
                        <span class="badge-glass" style="background: rgba(255, 255, 255, 0.05);">{{ bot.strategy_type }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% if bot.description %}
            <p class="text-secondary mb-0">{{ bot.description }}</p>
            {% endif %}
        </div>

        <!-- Bot Information Sections -->
        
        <!-- Allowed Symbols -->
        <div class="section-header">
            <h3 class="section-title">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</h3>
        </div>
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            {% if bot.allowed_symbols %}
            <div class="d-flex flex-wrap gap-2">
                {% for symbol in bot.allowed_symbols %}
                <span class="badge-glass" style="background: rgba(21, 139, 249, 0.1); color: #158bf9; font-size: 0.9rem; padding: 8px 16px;">{{ symbol }}</span>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-secondary mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            {% endif %}
        </div>

        <!-- Allowed Packages -->
        <div class="section-header">
            <h3 class="section-title">‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏Å‡∏à‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</h3>
        </div>
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            {% if allowed_packages %}
            <div class="d-flex flex-column gap-3">
                {% for package in allowed_packages %}
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle text-profit me-3" style="font-size: 1.2rem;"></i>
                    <span style="font-size: 1rem;">{{ package.name }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-secondary mb-0">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            {% endif %}
        </div>

        <!-- Current Parameters -->
        {% if bot.current_parameters %}
        <div class="section-header">
            <h3 class="section-title">Current Parameters</h3>
        </div>
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="border: none; padding: 12px;">Parameter</th>
                            <th style="border: none; padding: 12px;">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, value in bot.current_parameters.items %}
                        <tr>
                            <td style="padding: 12px;"><code style="color: rgba(255, 255, 255, 0.7);">{{ key }}</code></td>
                            <td style="padding: 12px; color: #158bf9;">{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Backtest Results -->
        {% if latest_backtest %}
        <div class="section-header">
            <h3 class="section-title">‡∏ú‡∏• Backtest ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        </div>
        
        <!-- Main Metrics -->
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div style="text-align: center;">
                    <div class="stat-label" style="margin-bottom: 8px;">Total Profit</div>
                    <div class="stat-value {% if latest_backtest.total_profit >= 0 %}text-profit{% else %}text-loss{% endif %}" style="font-size: 1.75rem;">
                        {{ latest_backtest.total_profit|floatformat:2 }}
                    </div>
                </div>
                <div style="text-align: center;">
                    <div class="stat-label" style="margin-bottom: 8px;">Win Rate</div>
                    <div class="stat-value {% if latest_backtest.win_rate >= 50 %}text-profit{% else %}text-loss{% endif %}" style="font-size: 1.75rem;">
                        {{ latest_backtest.win_rate|floatformat:2 }}%
                    </div>
                </div>
                <div style="text-align: center;">
                    <div class="stat-label" style="margin-bottom: 8px;">Max DD %</div>
                    <div class="stat-value text-loss" style="font-size: 1.75rem;">{{ latest_backtest.max_drawdown_percent|floatformat:2 }}%</div>
                </div>
            </div>
        </div>

        <!-- Detailed Stats -->
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="stat-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>
                <span class="badge-glass" style="font-size: 0.85rem;">
                    {{ latest_backtest.backtest_start_date|date:"d M Y" }} - {{ latest_backtest.backtest_end_date|date:"d M Y" }}
                </span>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px;">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Total Trades</span>
                    <span class="stat-value" style="font-size: 0.95rem;">{{ latest_backtest.total_trades }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Wins</span>
                    <span class="stat-value text-profit" style="font-size: 0.95rem;">{{ latest_backtest.winning_trades }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Losses</span>
                    <span class="stat-value text-loss" style="font-size: 0.95rem;">{{ latest_backtest.losing_trades }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Avg/Trade</span>
                    <span class="stat-value" style="font-size: 0.95rem;">{{ latest_backtest.avg_profit_per_trade|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Best Trade</span>
                    <span class="stat-value text-profit" style="font-size: 0.95rem;">{{ latest_backtest.best_trade|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Worst Trade</span>
                    <span class="stat-value text-loss" style="font-size: 0.95rem;">{{ latest_backtest.worst_trade|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="stat-label" style="font-size: 0.9rem;">Max Drawdown</span>
                    <span class="stat-value text-loss" style="font-size: 0.95rem;">{{ latest_backtest.max_drawdown|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- Equity Curve -->
        {% if latest_backtest.equity_curve_image %}
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            <h4 class="mb-3" style="font-size: 1rem; color: rgba(255, 255, 255, 0.7);">Equity Curve</h4>
            <img src="{{ latest_backtest.equity_curve_image.url }}" alt="Equity Curve" class="img-fluid rounded" style="max-width: 100%; height: auto;">
        </div>
        {% endif %}
        {% else %}
        <div class="section-header">
            <h3 class="section-title">‡∏ú‡∏• Backtest</h3>
        </div>
        <div class="empty-state glass-card-static">
            <i class="bi bi-graph-up"></i>
            <div class="empty-state-title">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏• Backtest</div>
            <div class="empty-state-text">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ú‡∏• Backtest</div>
        </div>
        {% endif %}

        <!-- User Action Section (if logged in) -->
        {% if user.is_authenticated and user_accounts %}
        <div class="section-header">
            <h3 class="section-title">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Bot ‡∏ô‡∏µ‡πâ</h3>
        </div>
        <div class="glass-card fade-in mb-3" style="padding: 20px;">
            <p class="text-secondary mb-3" style="font-size: 0.9rem;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Bot ‡∏ô‡∏µ‡πâ</p>
            
            {% for account in user_accounts %}
            <div class="d-flex justify-content-between align-items-center mb-2 p-3 rounded" style="background: rgba(255,255,255,0.03);">
                <div>
                    <div style="font-weight: 500;">{{ account.account_name }}</div>
                    <div class="text-secondary" style="font-size: 0.85rem;">{{ account.mt5_account_id }}</div>
                </div>
                {% if account.active_bot.id == bot.id %}
                <span class="badge-glass badge-active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                {% else %}
                <form method="post" action="{% url 'account_bot_activate' account.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="bot_id" value="{{ bot.id }}">
                    <button type="submit" class="btn btn-primary-blue btn-sm">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block bottom_nav %}
{% include 'base/bottom_nav.html' %}
{% endblock %}
